name: Publish Extension

on:
  workflow_run:
    workflows: ["Test and Build VSCode"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [linux, darwin, win32]    
        arch: [x64, arm64]     
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      # Install npm dependencies based on the architecture
      - name: Install dependencies
        run: |
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            npm_config_arch=arm64 npm install --build-from-source
          else
            npm_config_arch=x64 npm install --build-from-source
          fi

      - name: Run Rollup for Compilation
        run: npm run rollupci

      - name: List Compiled Files (Debugging)
        run: ls -R out/compiled

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package VSIX for Target Platform
        run: |
          case "${{ matrix.os }}" in
            linux)  vsce package --target linux-${{ matrix.arch }} ;;
            darwin) vsce package --target darwin-${{ matrix.arch }} ;;
            win32)  vsce package --target win32-${{ matrix.arch }} ;;
          esac

      - name: Capture VSIX Filename
        id: capture_vsix_file
        run: |
          VSIX_FILE=$(ls *.vsix)
          echo "VSIX_FILE=$VSIX_FILE" >> $GITHUB_ENV
        shell: bash

      - name: Print VSIX Filename
        id: print_vsix_file
        run: |
          echo "Generated package for OS ${{ matrix.os }} and architecture ${{ matrix.arch }}:"
          ls *.vsix

      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v1
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          extensionFile: ${{ env.VSIX_FILE }}
          registryUrl: https://marketplace.visualstudio.com
          skipDuplicate: true
