name: Publish Extension

on:
  workflow_run:
    workflows: ["Test and Build VSCode"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]  # Define the architectures
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      # Install npm dependencies based on the architecture
      - name: Install dependencies
        run: |
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            npm_config_arch=arm64 npm install --build-from-source
          else
            npm_config_arch=x64 npm install --build-from-source
          fi

      # Run Rollup for compilation
      - name: Run Rollup
        run: npm run rollupci

      - name: List contents of out/compiled directory (for debugging)
        run: ls -R out/compiled
      
      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v1
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          target: |
            ${{ matrix.arch == 'arm64' && 'linux-arm64,darwin-arm64,win32-arm64' || 'linux-x64,darwin-x64,win32-x64' }}
          registryUrl: https://marketplace.visualstudio.com
          skipDuplicate: true
